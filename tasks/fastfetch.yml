# =============================================================================
# Fastfetch Installation + Login Hook (Multi-Platform)
# =============================================================================

# -------------------------------------------------------------------------
# Debian: Try apt first, fall back to GitHub .deb
# -------------------------------------------------------------------------
- name: Check if fastfetch is available in apt (Debian)
  ansible.builtin.shell: apt-cache show fastfetch 2>/dev/null | grep -q "^Package:"
  register: fastfetch_apt_available
  changed_when: false
  failed_when: false
  when: ansible_facts.os_family == "Debian"

- name: Install fastfetch from apt (Debian)
  ansible.builtin.apt:
    name: fastfetch
    state: present
  when:
    - ansible_facts.os_family == "Debian"
    - fastfetch_apt_available.rc == 0

- name: Get latest fastfetch release from GitHub (Debian - fallback)
  ansible.builtin.uri:
    url: https://api.github.com/repos/fastfetch-cli/fastfetch/releases/latest
    return_content: true
  register: fastfetch_release
  when:
    - ansible_facts.os_family == "Debian"
    - fastfetch_apt_available.rc != 0

- name: Set fastfetch deb URL (Debian - fallback)
  ansible.builtin.set_fact:
    fastfetch_deb_url: >-
      {{
        fastfetch_release.json.assets
        | selectattr('name', 'match', '.*linux-' + (ansible_architecture | replace('x86_64', 'amd64') | replace('aarch64', 'aarch64')) + '\.deb$')
        | map(attribute='browser_download_url')
        | first
      }}
  when:
    - ansible_facts.os_family == "Debian"
    - fastfetch_apt_available.rc != 0

- name: Install fastfetch from GitHub .deb (Debian - fallback)
  ansible.builtin.apt:
    deb: "{{ fastfetch_deb_url }}"
    state: present
  when:
    - ansible_facts.os_family == "Debian"
    - fastfetch_apt_available.rc != 0
    - fastfetch_deb_url is defined

# -------------------------------------------------------------------------
# Arch Linux: Use pacman
# -------------------------------------------------------------------------
- name: Install fastfetch (Arch)
  community.general.pacman:
    name: fastfetch
    state: present
  when: ansible_facts.os_family == "Archlinux"

# -------------------------------------------------------------------------
# macOS: Use Homebrew
# -------------------------------------------------------------------------
- name: Install fastfetch (macOS)
  community.general.homebrew:
    name: fastfetch
    state: present
  when: ansible_facts.os_family == "Darwin"

# -------------------------------------------------------------------------
# Bash login hook (Linux only)
# -------------------------------------------------------------------------
- name: Add fastfetch to johnny's .bashrc (Linux)
  ansible.builtin.blockinfile:
    path: "/home/{{ admin_user }}/.bashrc"
    marker: "# {mark} ANSIBLE_FASTFETCH"
    block: |
      if [ -t 1 ] && command -v fastfetch >/dev/null && [ -z "$FASTFETCH_SHOWN" ]; then
        export FASTFETCH_SHOWN=1
        fastfetch
      fi
    create: true
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: "0644"
  when: ansible_facts.os_family != "Darwin"

# -------------------------------------------------------------------------
# Zsh login hook (macOS)
# -------------------------------------------------------------------------
- name: Add fastfetch to johnny's .zshrc (macOS)
  ansible.builtin.blockinfile:
    path: "/Users/{{ admin_user }}/.zshrc"
    marker: "# {mark} ANSIBLE_FASTFETCH"
    block: |
      if [ -t 1 ] && command -v fastfetch >/dev/null && [ -z "$FASTFETCH_SHOWN" ]; then
        export FASTFETCH_SHOWN=1
        fastfetch
      fi
    create: true
    owner: "{{ admin_user }}"
    mode: "0644"
  when: ansible_facts.os_family == "Darwin"
