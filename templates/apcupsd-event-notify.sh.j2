#!/bin/bash
# apcupsd event notification script - Managed by Ansible
# Sends email notifications for UPS events via msmtp

EVENT="$1"
HOSTNAME=$(hostname)
MAILTO="{{ apcupsd_alert_email | default('root') }}"
FROM="{{ msmtp_from_address | default('jn@jnalley.me') }}"

send_mail() {
    local subject="$1"
    local body="$2"

    printf "Subject: [UPS] %s: %s\nTo: %s\nFrom: %s\n\n%s" \
        "$HOSTNAME" "$subject" "$MAILTO" "$FROM" "$body" | /usr/sbin/sendmail "$MAILTO"
}

case "$EVENT" in
    onbattery)
        STATUS=$(apcaccess status 2>/dev/null || echo "Unable to query status")
        send_mail "Running on battery power" "UPS is now running on battery power.\n\nUPS Status:\n${STATUS}"
        ;;
    offbattery)
        STATUS=$(apcaccess status 2>/dev/null || echo "Unable to query status")
        send_mail "Power restored" "UPS is back on mains power.\n\nUPS Status:\n${STATUS}"
        ;;
    commfailure)
        send_mail "Communication failure" "Lost communication with UPS."
        ;;
    commok)
        send_mail "Communication restored" "Communication with UPS restored."
        ;;
esac

exit 0
