# =============================================================================
# Local Restic Backup Playbook - Backups to ts440 ZFS
# =============================================================================
# Usage: ansible-playbook playbooks/local-restic.yml
#        ansible-playbook playbooks/local-restic.yml --limit docker-vm
# =============================================================================

- name: Configure local restic backups to ts440 ZFS
  hosts: backup_clients
  become: true
  gather_facts: true

  vars:
    local_restic_env_file: /etc/restic/local-backup.env
    local_restic_script: /usr/local/sbin/restic-local-backup
    local_restic_ssh_key: /etc/restic/backup_key
    local_restic_cache_dir: /var/cache/restic-local

  tasks:
    # =========================================================================
    # Skip hosts without local_restic_enabled
    # =========================================================================
    - name: Check if local restic is enabled
      ansible.builtin.meta: end_host
      when: not (local_restic_enabled | default(false))

    # =========================================================================
    # Install restic (if not already installed by B2 playbook)
    # =========================================================================
    - name: Install restic (Debian)
      ansible.builtin.apt:
        name: restic
        state: present
        update_cache: true
      when: ansible_facts.os_family == "Debian"
      tags: [install]

    - name: Install restic (Arch)
      community.general.pacman:
        name: restic
        state: present
      when: ansible_facts.os_family == "Archlinux"
      tags: [install]

    # =========================================================================
    # Create directories
    # =========================================================================
    - name: Create /etc/restic directory
      ansible.builtin.file:
        path: /etc/restic
        state: directory
        owner: root
        group: root
        mode: "0700"
      tags: [config]

    - name: Create local restic cache directory
      ansible.builtin.file:
        path: "{{ local_restic_cache_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0700"
      tags: [config]

    # =========================================================================
    # SSH key for SFTP access to ts440
    # =========================================================================
    - name: Install SSH private key for backup
      ansible.builtin.copy:
        content: "{{ local_restic_ssh_private_key }}"
        dest: "{{ local_restic_ssh_key }}"
        owner: root
        group: root
        mode: "0600"
      no_log: true
      tags: [ssh]

    - name: Create SSH config for backup host
      ansible.builtin.blockinfile:
        path: /root/.ssh/config
        create: true
        owner: root
        group: root
        mode: "0600"
        marker: "# {mark} ANSIBLE MANAGED - restic backup to ts440"
        block: |
          Host {{ local_restic_target_host }}
            IdentityFile {{ local_restic_ssh_key }}
            StrictHostKeyChecking accept-new
            UserKnownHostsFile /root/.ssh/known_hosts
      tags: [ssh]

    # =========================================================================
    # Environment file
    # =========================================================================
    - name: Create local restic environment file
      ansible.builtin.copy:
        content: |
          # Local restic backup configuration
          # Managed by Ansible - do not edit manually

          # Repository location (SFTP to ts440)
          RESTIC_REPOSITORY={{ local_restic_repository }}

          # Repository password (same as B2 for consistency)
          RESTIC_PASSWORD={{ restic_password }}

          # Cache directory
          RESTIC_CACHE_DIR={{ local_restic_cache_dir }}
        dest: "{{ local_restic_env_file }}"
        owner: root
        group: root
        mode: "0600"
      no_log: true
      tags: [config]

    # =========================================================================
    # Initialize repository (idempotent)
    # =========================================================================
    - name: Check if local restic repo exists
      ansible.builtin.shell: |
        set -a; . {{ local_restic_env_file }}; set +a
        restic cat config > /dev/null 2>&1
      args:
        executable: /bin/bash
      register: local_restic_repo_check
      changed_when: false
      failed_when: false
      tags: [init]

    - name: Initialize local restic repository
      ansible.builtin.shell: |
        set -a; . {{ local_restic_env_file }}; set +a
        restic init
      args:
        executable: /bin/bash
      when: local_restic_repo_check.rc != 0
      tags: [init]

    # =========================================================================
    # Backup script
    # =========================================================================
    - name: Build local backup paths list
      ansible.builtin.set_fact:
        local_restic_all_paths: "{{ local_restic_backup_paths | default(['/opt']) }}"
      tags: [script]

    - name: Create local restic backup script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          set -euo pipefail

          LOG_TAG="restic-local-backup"
          log() { logger -t "$LOG_TAG" "$*"; echo "$*"; }

          # Load environment
          set -a
          source {{ local_restic_env_file }}
          set +a

          # Ensure HOME is set for restic
          export HOME=/root

          log "Starting local backup to {{ local_restic_repository }}..."

          # Run backup
          restic backup \
            --verbose \
            --tag "{{ inventory_hostname }}" \
            --tag "local" \
          {% for exclude in restic_excludes | default([]) %}
            --exclude "{{ exclude }}" \
          {% endfor %}
          {% for path in local_restic_all_paths %}
            "{{ path }}" \
          {% endfor %}

          log "Backup complete. Running retention policy..."

          # Apply retention policy
          restic forget \
            --verbose \
            --prune \
            --keep-hourly {{ local_restic_retention.keep_hourly }} \
            --keep-daily {{ local_restic_retention.keep_daily }} \
            --keep-weekly {{ local_restic_retention.keep_weekly }} \
            --keep-monthly {{ local_restic_retention.keep_monthly }}

          log "Local backup and maintenance complete"
        dest: "{{ local_restic_script }}"
        owner: root
        group: root
        mode: "0700"
      tags: [script]

    # =========================================================================
    # Systemd service and timer (hourly)
    # =========================================================================
    - name: Create restic-local-backup systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Restic Local Backup to ts440 ZFS
          After=network-online.target
          Wants=network-online.target
          {% if restic_require_ac_power | default(false) %}
          ConditionACPower=true
          {% endif %}

          [Service]
          Type=oneshot
          ExecStart={{ local_restic_script }}
          StandardOutput=journal
          StandardError=journal

          # Run as root
          User=root

          # Environment for restic
          Environment=HOME=/root
          Environment=RESTIC_CACHE_DIR={{ local_restic_cache_dir }}

          # Resource limits
          Nice=19
          IOSchedulingClass=idle

          # Timeout (1 hour should be plenty for local backups)
          TimeoutStartSec=3600
        dest: /etc/systemd/system/restic-local-backup.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd
      tags: [systemd]

    - name: Create restic-local-backup systemd timer (hourly)
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Hourly local restic backup timer

          [Timer]
          OnCalendar=hourly
          RandomizedDelaySec=5m
          Persistent=true

          [Install]
          WantedBy=timers.target
        dest: /etc/systemd/system/restic-local-backup.timer
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Enable local restic timer
      tags: [systemd]

    - name: Ensure restic-local-backup timer is enabled and started
      ansible.builtin.systemd:
        name: restic-local-backup.timer
        enabled: true
        state: started
        daemon_reload: true
      tags: [systemd]

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable local restic timer
      ansible.builtin.systemd:
        name: restic-local-backup.timer
        enabled: true
        state: started


# =============================================================================
# Install public key on ts440 (backup target)
# =============================================================================
- name: Configure ts440 to accept backup connections
  hosts: ts440
  become: true
  gather_facts: false

  tasks:
    - name: Ensure backup public key is authorized
      ansible.posix.authorized_key:
        user: johnny
        key: "{{ local_restic_ssh_public_key }}"
        state: present
        comment: "restic-backup from homelab clients"
      tags: [ssh]

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: /srv/nas-zfs/backups
        state: directory
        owner: johnny
        group: johnny
        mode: "0755"
      tags: [config]
