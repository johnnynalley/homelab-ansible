# =============================================================================
# Smartmontools Playbook - SMART Disk Monitoring and Alerting
# =============================================================================
# Configures smartd for disk health monitoring with email alerts.
# Targets all physical Linux hosts (VMs/LXCs excluded - virtual disks
# don't expose SMART data; the Proxmox host monitors real drives).
#
# Requires msmtp for email delivery.
#
# Usage: ansible-playbook playbooks/smartmontools.yml
#        ansible-playbook playbooks/smartmontools.yml --limit ts440
# =============================================================================

- name: Configure SMART disk monitoring
  hosts: linux_hosts
  become: true
  gather_facts: true

  tasks:
    - name: Skip hosts without smartd enabled
      ansible.builtin.meta: end_host
      when: not (smartd_enabled | default(false))

    - name: Install smartmontools (Debian)
      ansible.builtin.apt:
        name: smartmontools
        state: present
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts.os_family == "Debian"

    - name: Install smartmontools (Arch)
      community.general.pacman:
        name: smartmontools
        state: present
      when: ansible_facts.os_family == "Archlinux"

    - name: Configure smartd
      ansible.builtin.template:
        src: ../templates/smartd.conf.j2
        dest: /etc/smartd.conf
        owner: root
        group: root
        mode: "0644"
        backup: true
      notify: Restart smartd

    - name: Ensure smartd is enabled and running
      ansible.builtin.systemd:
        name: smartd
        enabled: true
        state: started

  handlers:
    - name: Restart smartd
      ansible.builtin.systemd:
        name: smartd
        state: restarted
