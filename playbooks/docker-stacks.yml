# =============================================================================
# Docker Stacks Playbook - Deploy Docker Compose Services
# =============================================================================
# Deploys Docker Compose stacks defined in host_vars docker_stacks variable
# Usage: ansible-playbook playbooks/docker-stacks.yml
#        ansible-playbook playbooks/docker-stacks.yml --limit docker-vm
# =============================================================================

- name: Deploy Docker Compose stacks
  hosts: linux_hosts
  become: true
  gather_facts: true

  tasks:
    - name: Skip hosts without docker_stacks defined
      ansible.builtin.meta: end_host
      when: docker_stacks is not defined or docker_stacks | length == 0

    # Create Docker networks before starting stacks
    - name: Ensure Docker networks exist
      ansible.builtin.import_tasks: ../tasks/docker-network.yml

    # Create systemd service to start stacks with proper network dependencies
    - name: Create docker-stacks systemd service
      ansible.builtin.template:
        src: ../templates/docker-stacks.service.j2
        dest: /etc/systemd/system/docker-stacks.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Enable docker-stacks service
      ansible.builtin.systemd:
        name: docker-stacks
        enabled: true
        daemon_reload: true

    # -------------------------------------------------------------------------
    # Stacks with build: true - rebuild images from Dockerfile
    # -------------------------------------------------------------------------
    - name: Build and pull images (build stacks)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose build --pull 2>&1
      loop: "{{ docker_stacks | selectattr('build', 'equalto', true) | list }}"
      loop_control:
        label: "{{ item.name }}"
      retries: 3
      delay: 10
      register: build_result
      until: build_result.rc == 0
      changed_when: false

    - name: Update containers (build stacks)
      ansible.builtin.shell: |
        cd "{{ item.item.path }}" && docker compose up -d 2>&1
      loop: "{{ build_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      register: up_build_result
      changed_when: "'Recreat' in up_build_result.stdout or 'Creat' in up_build_result.stdout or 'Start' in up_build_result.stdout"
      when: build_result.results is defined

    # -------------------------------------------------------------------------
    # Stacks with build: false - pull prebuilt images only
    # -------------------------------------------------------------------------
    - name: Pull images (pull-only stacks)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose pull 2>&1
      loop: "{{ docker_stacks | selectattr('build', 'equalto', false) | list }}"
      loop_control:
        label: "{{ item.name }}"
      retries: 3
      delay: 10
      register: pull_result
      until: pull_result.rc == 0
      changed_when: "'Pull complete' in pull_result.stdout or 'Downloaded newer' in pull_result.stdout"

    - name: Update containers if images changed (pull-only stacks)
      ansible.builtin.shell: |
        cd "{{ item.item.path }}" && docker compose up -d 2>&1
      loop: "{{ pull_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      register: up_pull_result
      changed_when: "'Recreat' in up_pull_result.stdout or 'Creat' in up_pull_result.stdout or 'Start' in up_pull_result.stdout"
      when:
        - pull_result.results is defined
        - item.changed or item.stdout is search('Pull complete') or item.stdout is search('Downloaded newer')

    # -------------------------------------------------------------------------
    # Ensure stacks are in desired state (start: true/false, default true)
    # -------------------------------------------------------------------------
    - name: Start stacks (start=true or undefined)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose up -d 2>&1
      loop: "{{ docker_stacks | selectattr('start', 'undefined') | list + docker_stacks | selectattr('start', 'defined') | selectattr('start', 'equalto', true) | list }}"
      loop_control:
        label: "{{ item.name }}"
      register: start_result
      changed_when: "'Started' in start_result.stdout or 'Created' in start_result.stdout"

    - name: Stop stacks (start=false)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose stop 2>&1
      loop: "{{ docker_stacks | selectattr('start', 'defined') | selectattr('start', 'equalto', false) | list }}"
      loop_control:
        label: "{{ item.name }}"
      register: stop_result
      changed_when: "'Stopped' in stop_result.stdout"

    - name: Prune dangling Docker images
      ansible.builtin.shell: docker image prune -f
      register: prune_result
      changed_when: "'Total reclaimed space' in prune_result.stdout and 'Total reclaimed space: 0B' not in prune_result.stdout"

    - name: Report pruned images
      ansible.builtin.debug:
        msg: "{{ prune_result.stdout_lines | select('search', 'Total reclaimed') | first | default('No images pruned') }}"
      when: prune_result.stdout_lines | select('search', 'Total reclaimed') | list | length > 0

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
