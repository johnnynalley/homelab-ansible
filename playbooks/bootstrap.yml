# =============================================================================
# Bootstrap Playbook - Create admin user
# =============================================================================
# One-time setup for new hosts. Run as root with password auth:
#   ansible-playbook playbooks/bootstrap.yml -u root --ask-pass --limit new-host
#
# After bootstrap, run site.yml to complete configuration (packages, SSH hardening, etc.)
# The admin_user variable controls which user is created (default: jnalley, legacy hosts: johnny)
# =============================================================================

- name: Bootstrap admin user
  hosts: linux_hosts
  become: true
  gather_facts: true

  vars:
    ssh_pubkey_path: "~/.ssh/id_ed25519.pub"
    ansible_pubkey_path: "~/.ssh/ansible_ed25519.pub"

  tasks:
    # =========================================================================
    # Install sudo (not installed by default on Proxmox)
    # =========================================================================
    - name: Install sudo package (Debian)
      ansible.builtin.apt:
        name: sudo
        state: present
        update_cache: true
      when: ansible_facts.os_family == "Debian"
      tags: [sudo]

    - name: Install sudo package (Arch)
      community.general.pacman:
        name: sudo
        state: present
      when: ansible_facts.os_family == "Archlinux"
      tags: [sudo]

    # =========================================================================
    # Create admin user
    # =========================================================================
    - name: Create admin user
      ansible.builtin.user:
        name: "{{ admin_user }}"
        shell: "{{ admin_shell }}"
        groups: "{{ 'wheel' if ansible_facts.os_family == 'Archlinux' else 'sudo' }}"
        append: true
        create_home: true
        password: "{{ admin_default_password | password_hash('sha512') }}"
        update_password: on_create
      tags: [user]

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "/home/{{ admin_user }}/.ssh"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: "0700"
      tags: [ssh]

    - name: Install SSH public key for admin user
      ansible.posix.authorized_key:
        user: "{{ admin_user }}"
        key: "{{ lookup('file', ssh_pubkey_path) }}"
        state: present
      tags: [ssh]

    - name: Install Ansible automation SSH key
      ansible.posix.authorized_key:
        user: "{{ admin_user }}"
        key: "{{ lookup('file', ansible_pubkey_path) }}"
        state: present
      tags: [ssh]

    # =========================================================================
    # Sudo configuration for Ansible
    # =========================================================================
    - name: Allow sudo without TTY (required for Ansible)
      ansible.builtin.copy:
        content: |
          # Allow {{ admin_user }} to use sudo without TTY (required for Ansible)
          # Password is still required - provided via ansible_become_password in vault
          Defaults:{{ admin_user }} !requiretty
        dest: /etc/sudoers.d/ansible-{{ admin_user }}
        owner: root
        group: root
        mode: "0440"
        validate: "visudo -cf %s"
      tags: [sudo]

    # =========================================================================
    # Enable PubkeyAuthentication (required before disabling password auth)
    # =========================================================================
    - name: Enable SSH public key authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        validate: "sshd -t -f %s"
      notify: Reload SSH
      tags: [ssh]

  handlers:
    - name: Reload SSH
      ansible.builtin.systemd:
        name: "{{ 'ssh' if ansible_facts.os_family == 'Debian' else 'sshd' }}"
        state: reloaded
