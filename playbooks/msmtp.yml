# =============================================================================
# msmtp Playbook - Lightweight SMTP Relay
# =============================================================================
# Configures msmtp as a local mail relay for system notifications
# (smartmontools, apcupsd, cron, etc.)
#
# Each host sends directly to iCloud SMTP - no central relay.
# Password stored in /etc/msmtp-pass (vault-encrypted source).
#
# Usage: ansible-playbook playbooks/msmtp.yml
#        ansible-playbook playbooks/msmtp.yml --limit proxmox_nodes
# =============================================================================

- name: Configure msmtp mail relay
  hosts: linux_hosts
  become: true
  gather_facts: true

  tasks:
    - name: Skip hosts without msmtp enabled
      ansible.builtin.meta: end_host
      when: not (msmtp_enabled | default(false))

    - name: Install msmtp packages (Debian)
      ansible.builtin.apt:
        name:
          - msmtp
          - msmtp-mta
          - bsd-mailx
        state: present
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts.os_family == "Debian"

    - name: Install msmtp packages (Arch)
      community.general.pacman:
        name:
          - msmtp
          - msmtp-mta
        state: present
      when: ansible_facts.os_family == "Archlinux"

    - name: Deploy msmtp password file
      ansible.builtin.copy:
        content: "{{ msmtp_smtp_password }}"
        dest: /etc/msmtp-pass
        owner: root
        group: root
        mode: "0600"
      no_log: true

    - name: Deploy msmtp configuration
      ansible.builtin.template:
        src: ../templates/msmtprc.j2
        dest: /etc/msmtprc
        owner: root
        group: root
        mode: "0600"

    - name: Configure mail aliases
      ansible.builtin.copy:
        content: |
          # Mail aliases - Managed by Ansible
          postmaster: root
          nobody: root
          hostmaster: root
          webmaster: root
          www: root
          root: {{ msmtp_default_recipient }}
          default: {{ msmtp_default_recipient }}
        dest: /etc/aliases
        owner: root
        group: root
        mode: "0644"
