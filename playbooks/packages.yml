# =============================================================================
# Packages Playbook - Multi-Platform Package Installation
# =============================================================================
# Supports: Debian/Ubuntu, Arch Linux, macOS
# Usage: ansible-playbook playbooks/packages.yml
#        ansible-playbook playbooks/packages.yml --limit proxmox_nodes
# =============================================================================

# -----------------------------------------------------------------------------
# Linux hosts (with become/sudo)
# -----------------------------------------------------------------------------
- name: Install baseline packages (Linux hosts)
  hosts: linux_hosts
  become: true
  gather_facts: true

  tasks:
    # =========================================================================
    # Locale baseline (Debian only)
    # =========================================================================
    - name: Ensure locale baseline (Debian)
      ansible.builtin.import_tasks: ../tasks/locale.yml
      when: ansible_facts.os_family == "Debian"
      tags: [locale]

    # =========================================================================
    # Tailscale repository and package (Linux only)
    # =========================================================================
    - name: Ensure Tailscale repo + package (Linux)
      ansible.builtin.import_tasks: ../tasks/tailscale.yml
      tags: [tailscale]

    # =========================================================================
    # Debian/Ubuntu Package Installation
    # =========================================================================
    - name: Update apt cache (Debian)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts.os_family == "Debian"
      tags: [packages, apt]

    - name: Build Debian package list
      ansible.builtin.set_fact:
        packages_debian_all: >-
          {{
            (packages_linux_common | default([]))
            + (packages_linux_extra | default([]))
            + (packages_debian_extra | default([]))
            + (packages_proxmox_extra | default([]))
            + (packages_vms_lxcs_extra | default([]))
            + (packages_vms_extra | default([]))
            + (packages_lxcs_extra | default([]))
            + (packages_orchestrator_extra | default([]))
            + (packages_debian_workstations_extra | default([]))
            + (packages_host_extra | default([]))
            | flatten | unique
          }}
      when: ansible_facts.os_family == "Debian"
      tags: [packages]

    - name: Install packages (Debian)
      ansible.builtin.apt:
        name: "{{ packages_debian_all }}"
        state: present
      when: ansible_facts.os_family == "Debian"
      tags: [packages, apt]

    - name: Remove unwanted packages (Debian)
      ansible.builtin.apt:
        name: "{{ packages_remove | default([]) }}"
        state: absent
      when:
        - ansible_facts.os_family == "Debian"
        - (packages_remove | default([])) | length > 0
      tags: [packages, apt]

    # =========================================================================
    # GitHub .deb packages (Debian workstations — version-checked)
    # =========================================================================
    - name: Install GitHub .deb packages
      ansible.builtin.include_tasks: ../tasks/github-debs.yml
      when:
        - ansible_facts.os_family == "Debian"
        - (deb_debian_workstations | default([])) | length > 0
      tags: [packages, apt, deb]

    # =========================================================================
    # Flatpak apps (Debian workstations — apps not in apt repos)
    # =========================================================================
    - name: Install Flatpak apps from Flathub
      ansible.builtin.include_tasks: ../tasks/flatpak.yml
      when:
        - ansible_facts.os_family == "Debian"
        - (flatpak_workstations | default([])) | length > 0
      tags: [packages, flatpak]

    # =========================================================================
    # Docker (Official Repo) - for hosts with install_docker: true
    # =========================================================================
    - name: Install Docker from official repo
      ansible.builtin.include_tasks: ../tasks/docker.yml
      when:
        - ansible_facts.os_family == "Debian"
        - install_docker | default(false)
      tags: [packages, docker]

    # =========================================================================
    # Arch Linux Package Installation
    # =========================================================================
    - name: Build Arch package list
      ansible.builtin.set_fact:
        packages_arch_all: >-
          {{
            (packages_linux_common | default([]))
            + (packages_linux_extra | default([]))
            + (packages_arch_extra | default([]))
            + (packages_arch_workstations_extra | default([]))
            + (packages_host_extra | default([]))
            | flatten | unique
          }}
      when: ansible_facts.os_family == "Archlinux"
      tags: [packages]

    - name: Update pacman cache (Arch)
      community.general.pacman:
        update_cache: true
      when: ansible_facts.os_family == "Archlinux"
      tags: [packages, pacman]

    - name: Install packages (Arch)
      community.general.pacman:
        name: "{{ packages_arch_all }}"
        state: present
      when: ansible_facts.os_family == "Archlinux"
      tags: [packages, pacman]

    # =========================================================================
    # Arch Linux AUR Package Installation (requires kewlfft.aur collection)
    # =========================================================================
    - name: Build AUR package list
      ansible.builtin.set_fact:
        packages_aur_all: >-
          {{
            (packages_aur_extra | default([]))
            | flatten | unique
          }}
      when: ansible_facts.os_family == "Archlinux"
      tags: [packages, aur]

    - name: Install AUR packages (Arch)
      kewlfft.aur.aur:
        name: "{{ packages_aur_all }}"
        state: present
      become: true
      become_user: "{{ admin_user }}"
      when:
        - ansible_facts.os_family == "Archlinux"
        - (packages_aur_all | default([])) | length > 0
      tags: [packages, aur]

    # =========================================================================
    # Fastfetch (Linux)
    # =========================================================================
    - name: Install fastfetch + login hook
      ansible.builtin.import_tasks: ../tasks/fastfetch.yml
      tags: [fastfetch]


# -----------------------------------------------------------------------------
# macOS hosts (no sudo needed for Homebrew)
# -----------------------------------------------------------------------------
- name: Install baseline packages (macOS hosts)
  hosts: macos_hosts
  become: false
  gather_facts: true

  tasks:
    # =========================================================================
    # macOS Package Installation (Homebrew)
    # =========================================================================
    - name: Ensure Homebrew is installed (macOS)
      ansible.builtin.stat:
        path: /opt/homebrew/bin/brew
      register: homebrew_check
      tags: [packages, homebrew]

    - name: Build macOS package list
      ansible.builtin.set_fact:
        packages_macos_all: >-
          {{
            (packages_macos_common | default([]))
            + (packages_host_extra | default([]))
            | flatten | unique
          }}
      tags: [packages]

    - name: Install Homebrew packages (macOS)
      community.general.homebrew:
        name: "{{ packages_macos_all }}"
        state: present
      when: homebrew_check.stat.exists | default(false)
      tags: [packages, homebrew]

    - name: Install Homebrew casks (macOS)
      community.general.homebrew_cask:
        name: "{{ packages_macos_casks }}"
        state: present
      when:
        - homebrew_check.stat.exists | default(false)
        - (packages_macos_casks | default([])) | length > 0
      tags: [packages, homebrew, casks]

    # =========================================================================
    # Fastfetch (macOS)
    # =========================================================================
    - name: Install fastfetch + login hook
      ansible.builtin.import_tasks: ../tasks/fastfetch.yml
      tags: [fastfetch]
