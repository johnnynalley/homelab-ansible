# =============================================================================
# Git Sync - Auto-pull repo on ts440 for Nextcloud External Storage
# =============================================================================
# Keeps /srv/nas-zfs/configs/ansible/homelab-ansible in sync with GitHub
# so Nextcloud's External Storage always shows the latest files.
#
# Usage: ansible-playbook playbooks/git-sync.yml
# =============================================================================

- name: Configure git-sync timer
  hosts: nas_server
  become: true

  vars:
    git_sync_repo_path: /srv/nas-zfs/configs/ansible/homelab-ansible
    git_sync_interval: "*-*-* *:0/5"  # every 5 minutes
    git_sync_user: johnny

  tasks:
    - name: Create git-sync service
      ansible.builtin.copy:
        dest: /etc/systemd/system/git-sync.service
        mode: "0644"
        content: |
          [Unit]
          Description=Pull latest homelab-ansible from GitHub
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          User={{ git_sync_user }}
          Environment=GIT_TERMINAL_PROMPT=0
          WorkingDirectory={{ git_sync_repo_path }}
          ExecStart=/usr/bin/git pull --ff-only
      notify: Reload systemd

    - name: Create git-sync timer
      ansible.builtin.copy:
        dest: /etc/systemd/system/git-sync.timer
        mode: "0644"
        content: |
          [Unit]
          Description=Pull homelab-ansible every 5 minutes

          [Timer]
          OnCalendar={{ git_sync_interval }}
          RandomizedDelaySec=30
          Persistent=true

          [Install]
          WantedBy=timers.target
      notify: Reload systemd

    - name: Enable and start git-sync timer
      ansible.builtin.systemd:
        name: git-sync.timer
        enabled: true
        state: started

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
