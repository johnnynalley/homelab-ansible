# =============================================================================
# Power Management Playbook - Laptop battery optimization
# =============================================================================
# Deploys:
#   - powertop auto-tune at boot (opt-in via powertop_autotune_enabled)
#   - Mask ModemManager for laptops without cellular (opt-in via disable_modem_manager)
#
# Usage: ansible-playbook playbooks/power-management.yml
#        ansible-playbook playbooks/power-management.yml --limit jn-t14s-lin
# =============================================================================

- name: Configure power management
  hosts: linux_hosts
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # powertop auto-tune at boot
    # Enables power-saving tunables: USB autosuspend, SATA link PM, audio
    # codec power save, PCIe runtime PM, etc. No performance impact â€” devices
    # wake instantly when used.
    # =========================================================================
    - name: Create powertop auto-tune systemd service
      ansible.builtin.copy:
        content: |
          # Managed by Ansible - playbooks/power-management.yml
          [Unit]
          Description=PowerTOP Auto-Tune
          After=multi-user.target

          [Service]
          Type=oneshot
          ExecStart=/usr/sbin/powertop --auto-tune
          RemainAfterExit=true

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/powertop-auto-tune.service
        owner: root
        group: root
        mode: "0644"
      when: powertop_autotune_enabled | default(false)
      notify:
        - Reload systemd
        - Enable powertop auto-tune

    - name: Ensure powertop auto-tune is enabled and started
      ansible.builtin.systemd:
        name: powertop-auto-tune.service
        enabled: true
        state: started
        daemon_reload: true
      when: powertop_autotune_enabled | default(false)

    # =========================================================================
    # Mask ModemManager (for laptops without cellular modems)
    # =========================================================================
    - name: Mask ModemManager
      ansible.builtin.systemd:
        name: ModemManager.service
        masked: true
        state: stopped
      when: disable_modem_manager | default(false)

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable powertop auto-tune
      ansible.builtin.systemd:
        name: powertop-auto-tune.service
        enabled: true
        state: started
