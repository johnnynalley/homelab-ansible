---
# =============================================================================
# Proxmox Firewall Configuration
# Manages datacenter, node, and VM/CT firewall rules
# =============================================================================
# Uses template to /tmp then moves to pmxcfs (which doesn't support atomic writes)
# =============================================================================

- name: Configure Proxmox Firewall
  hosts: proxmox_nodes
  become: true
  tasks:
    # Datacenter firewall
    - name: Template datacenter firewall to temp
      ansible.builtin.template:
        src: ../templates/proxmox-cluster-firewall.fw.j2
        dest: /tmp/cluster.fw
      run_once: true
      when: pve_firewall_ipsets is defined or pve_firewall_groups is defined

    - name: Copy datacenter firewall to pmxcfs
      ansible.builtin.shell: cp /tmp/cluster.fw /etc/pve/firewall/cluster.fw
      run_once: true
      when: pve_firewall_ipsets is defined or pve_firewall_groups is defined

    # Node firewall
    - name: Template node firewall to temp
      ansible.builtin.template:
        src: ../templates/proxmox-node-firewall.fw.j2
        dest: /tmp/host.fw
      when: pve_node_firewall is defined

    - name: Copy node firewall to pmxcfs
      ansible.builtin.shell: "cp /tmp/host.fw /etc/pve/nodes/{{ ansible_hostname }}/host.fw"
      when: pve_node_firewall is defined

    # VM/CT firewalls
    - name: Template VM/CT firewalls to temp
      ansible.builtin.template:
        src: ../templates/proxmox-vm-firewall.fw.j2
        dest: "/tmp/{{ item.key }}.fw"
      loop: "{{ pve_vm_firewalls | dict2items }}"
      when: pve_vm_firewalls is defined

    - name: Copy VM/CT firewalls to pmxcfs
      ansible.builtin.shell: "cp /tmp/{{ item.key }}.fw /etc/pve/firewall/{{ item.key }}.fw"
      loop: "{{ pve_vm_firewalls | dict2items }}"
      when: pve_vm_firewalls is defined
